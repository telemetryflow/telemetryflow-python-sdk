# =============================================================================
# TelemetryFlow Python SDK - Docker Compose
# =============================================================================
#
# TelemetryFlow Python SDK - Community Enterprise Observability Platform (CEOP)
# Copyright (c) 2024-2026 DevOpsCorner Indonesia. All rights reserved.
#
# Usage:
#   # Build SDK image
#   docker-compose build
#
#   # Run SDK generator (init command)
#   docker-compose run --rm sdk-gen init --project myapp --service my-service --output /workspace
#
#   # Run RESTful API generator
#   docker-compose run --rm sdk-restapi new --name my-api
#
#   # Start development environment with observability stack
#   docker-compose --profile dev up -d otel-collector jaeger
#
#   # Start full observability stack
#   docker-compose --profile full up -d
#
# =============================================================================
# OTLP HTTP Endpoints (Dual Ingestion Support)
# =============================================================================
#
#   TelemetryFlow Platform (Recommended - TFO Standalone):
#     POST http://localhost:4318/v2/traces
#     POST http://localhost:4318/v2/metrics
#     POST http://localhost:4318/v2/logs
#
#   OTEL Community (Backwards Compatible - OCB/Standard):
#     POST http://localhost:4318/v1/traces
#     POST http://localhost:4318/v1/metrics
#     POST http://localhost:4318/v1/logs
#
#   gRPC (Both versions via same port):
#     localhost:4317
#
#   NOTE: v2 endpoints require TFO Standalone build.
#         OCB builds support v1 endpoints only.
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # SDK Generator
  # ---------------------------------------------------------------------------
  sdk-gen:
    container_name: ${CONTAINER_NAME:-telemetryflow-python-sdk-gen}
    image: ${IMAGE_NAME:-telemetryflow/telemetryflow-python-sdk}:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-1.1.1}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        GIT_BRANCH: ${GIT_BRANCH:-main}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    entrypoint: ["telemetryflow-gen"]
    command: ["--help"]
    volumes:
      - ./workspace:/workspace
    working_dir: /workspace
    networks:
      - telemetryflow-sdk

  # ---------------------------------------------------------------------------
  # RESTful API Generator
  # ---------------------------------------------------------------------------
  sdk-restapi:
    container_name: ${CONTAINER_NAME_RESTAPI:-telemetryflow-python-sdk-restapi}
    image: ${IMAGE_NAME:-telemetryflow/telemetryflow-python-sdk}:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        GIT_BRANCH: ${GIT_BRANCH:-main}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    entrypoint: ["python"]
    command: ["-c", "from telemetryflow import TelemetryFlowBuilder; print('SDK Ready!')"]
    environment:
      - TELEMETRYFLOW_API_KEY_ID=${TELEMETRYFLOW_API_KEY_ID:-tfk_example}
      - TELEMETRYFLOW_API_KEY_SECRET=${TELEMETRYFLOW_API_KEY_SECRET:-tfs_example}
      - TELEMETRYFLOW_ENDPOINT=${TELEMETRYFLOW_ENDPOINT:-otel-collector:4317}
      - TELEMETRYFLOW_SERVICE_NAME=${TELEMETRYFLOW_SERVICE_NAME:-telemetryflow-python-sdk}
      - TELEMETRYFLOW_SERVICE_VERSION=${TELEMETRYFLOW_SERVICE_VERSION:-1.0.0}
      - TELEMETRYFLOW_ENVIRONMENT=${TELEMETRYFLOW_ENVIRONMENT:-development}
    volumes:
      - ./workspace:/workspace
    working_dir: /workspace
    depends_on:
      otel-collector:
        condition: service_healthy
    networks:
      - telemetryflow-sdk
    profiles:
      - example

  # ---------------------------------------------------------------------------
  # SDK Development Container
  # ---------------------------------------------------------------------------
  sdk-dev:
    container_name: ${CONTAINER_NAME_RESTAPI:-telemetryflow-python-sdk-dev}
    image: ${IMAGE_NAME:-telemetryflow/telemetryflow-python-sdk}:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        VERSION: ${VERSION:-dev}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        GIT_BRANCH: ${GIT_BRANCH:-main}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    entrypoint: ["python"]
    command: ["-c", "from telemetryflow import TelemetryFlowBuilder; print('SDK Ready!')"]
    environment:
      - TELEMETRYFLOW_API_KEY_ID=${TELEMETRYFLOW_API_KEY_ID:-tfk_example}
      - TELEMETRYFLOW_API_KEY_SECRET=${TELEMETRYFLOW_API_KEY_SECRET:-tfs_example}
      - TELEMETRYFLOW_ENDPOINT=${TELEMETRYFLOW_ENDPOINT:-otel-collector:4317}
      - TELEMETRYFLOW_SERVICE_NAME=${TELEMETRYFLOW_SERVICE_NAME:-telemetryflow-python-sdk-dev}
      - TELEMETRYFLOW_SERVICE_VERSION=${TELEMETRYFLOW_SERVICE_VERSION:-1.0.0}
      - TELEMETRYFLOW_ENVIRONMENT=${TELEMETRYFLOW_ENVIRONMENT:-development}
    volumes:
      - .:/app
      - ./workspace:/workspace
    working_dir: /app
    depends_on:
      otel-collector:
        condition: service_healthy
    networks:
      - telemetryflow-sdk
    profiles:
      - dev

  # ---------------------------------------------------------------------------
  # OpenTelemetry Collector (for local development)
  # ---------------------------------------------------------------------------
  # Supports dual ingestion: v1 (OTEL standard) and v2 (TelemetryFlow enhanced)
  otel-collector:
    profiles:
      - dev
      - full
      - example
    platform: linux/amd64
    # =============================================================================
    # TelemetryFlow Collector (TFO-Collector) - TFO format with OTLP support (v1.1.2+)
    image: telemetryflow/telemetryflow-collector:${TFO_VERSION:-latest}
    command: ["--config=/etc/tfo-collector/tfo-collector.yaml"]
    # =============================================================================
    # TelemetryFlow Collector OCB (TFO-Collector-OCB) - Standard OTEL format
    # image: telemetryflow/telemetryflow-collector:${TFO_VERSION:-latest}
    # command: ["--config=/etc/tfo-collector/otel-collector.yaml"]
    # =============================================================================
    # OTEL Collector Community Contributor (Standard OTEL format)
    # image: otel/opentelemetry-collector-contrib:${OTEL_VERSION:-0.142.0}
    # command: ["--config=/etc/otelcol-contrib/config.yaml"]
    # =============================================================================
    container_name: ${CONTAINER_OTEL:-otel-collector-dev}
    restart: unless-stopped
    volumes:
      # TelemetryFlow Collector config (Custom TFO format)
      - ./configs/tfo-collector.yaml:/etc/tfo-collector/tfo-collector.yaml:ro
      # =============================================================================
      # TelemetryFlow Collector OCB config (Standard OTEL format)
      # - ./configs/otel-collector.yaml:/etc/tfo-collector/otel-collector.yaml:ro
      # =============================================================================
      # OTEL Collector Community Contributor config (Standard OTEL format)
      # - ./configs/otel-collector.yaml:/etc/otelcol-contrib/config.yaml:ro
    ports:
      - "${OTLP_GRPC_PORT:-4317}:4317"               # OTLP gRPC (v1 & v2)
      - "${OTLP_HTTP_PORT:-4318}:4318"               # OTLP HTTP (v1 & v2)
      - "${OTEL_METRICS_PORT:-8888}:8888"            # Prometheus metrics (self)
      - "${PROMETHEUS_EXPORTER_PORT:-8889}:8889"     # Prometheus exporter
      - "${OTEL_HEALTH_PORT:-13133}:13133"           # Health check
      - "${ZPAGES_PORT:-55679}:55679"                # zPages
      - "${PPROF_PORT:-1777}:1777"                   # pprof
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:13133"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - telemetryflow-sdk

  # ---------------------------------------------------------------------------
  # Jaeger (for trace visualization)
  # ---------------------------------------------------------------------------
  jaeger:
    container_name: jaeger-dev
    image: jaegertracing/jaeger:${JAEGER_VERSION:-2.13.0}
    ports:
      - "${JAEGER_UI_PORT:-16686}:16686"   # Jaeger UI
      - "${JAEGER_HTTP_PORT:-14268}:14268" # Jaeger HTTP collector
      - "${JAEGER_GRPC_PORT:-14250}:14250" # Jaeger gRPC
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - telemetryflow-sdk
    profiles:
      - dev
      - full

  # ---------------------------------------------------------------------------
  # Prometheus (for metrics visualization)
  # ---------------------------------------------------------------------------
  prometheus:
    container_name: prometheus-dev
    image: prom/prometheus:${PROMETHEUS_VERSION:-v2.54.1}
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./configs/prometheus.yaml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - telemetryflow-sdk
    profiles:
      - full

  # ---------------------------------------------------------------------------
  # Grafana (for dashboards)
  # ---------------------------------------------------------------------------
  grafana:
    container_name: grafana-dev
    image: grafana/grafana:${GRAFANA_VERSION:-11.4.0}
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./configs/grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - telemetryflow-sdk
    profiles:
      - full

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  telemetryflow-sdk:
    driver: bridge
    name: telemetryflow-python-sdk-network
