#!/bin/bash

# Pre-commit hook for TelemetryFlow Python SDK
# Runs: black, flake8/ruff, mypy, and security scan (bandit)

set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get staged Python files
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_PY_FILES" ]; then
    echo -e "${YELLOW}No Python files staged for commit. Skipping Python checks.${NC}"
    exit 0
fi

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

FAILED=0

# 1. Check black formatting
echo -e "\n${YELLOW}[1/4] Running black (formatter)...${NC}"
if command_exists black; then
    if ! black --check --quiet $STAGED_PY_FILES 2>&1; then
        echo -e "${RED}black found formatting issues:${NC}"
        black --diff $STAGED_PY_FILES 2>&1 || true
        echo -e "${YELLOW}Run 'black <file>' to fix${NC}"
        FAILED=1
    else
        echo -e "${GREEN}black passed${NC}"
    fi
else
    echo -e "${YELLOW}black not installed. Skipping format check.${NC}"
    echo -e "${YELLOW}Install with: pip install black${NC}"
fi

# 2. Run linter (ruff or flake8)
echo -e "\n${YELLOW}[2/4] Running linter...${NC}"
if command_exists ruff; then
    if ! ruff check $STAGED_PY_FILES 2>&1; then
        echo -e "${RED}ruff found issues${NC}"
        FAILED=1
    else
        echo -e "${GREEN}ruff passed${NC}"
    fi
elif command_exists flake8; then
    if ! flake8 $STAGED_PY_FILES 2>&1; then
        echo -e "${RED}flake8 found issues${NC}"
        FAILED=1
    else
        echo -e "${GREEN}flake8 passed${NC}"
    fi
else
    echo -e "${YELLOW}ruff/flake8 not installed. Skipping lint check.${NC}"
    echo -e "${YELLOW}Install with: pip install ruff${NC}"
    echo -e "${YELLOW}Or: pip install flake8${NC}"
fi

# 3. Run type checker (mypy)
echo -e "\n${YELLOW}[3/4] Running mypy (type checker)...${NC}"
if command_exists mypy; then
    if ! mypy $STAGED_PY_FILES --ignore-missing-imports 2>&1; then
        echo -e "${RED}mypy found type issues${NC}"
        # Type issues are warnings, not failures by default
        echo -e "${YELLOW}(mypy issues are warnings only)${NC}"
    else
        echo -e "${GREEN}mypy passed${NC}"
    fi
else
    echo -e "${YELLOW}mypy not installed. Skipping type check.${NC}"
    echo -e "${YELLOW}Install with: pip install mypy${NC}"
fi

# 4. Run security scan (bandit)
echo -e "\n${YELLOW}[4/4] Running security scan...${NC}"
if command_exists bandit; then
    if ! bandit -r $STAGED_PY_FILES -ll -q 2>&1; then
        echo -e "${RED}bandit found security issues${NC}"
        FAILED=1
    else
        echo -e "${GREEN}bandit passed${NC}"
    fi
elif command_exists safety; then
    echo -e "${YELLOW}Running safety check on dependencies...${NC}"
    if ! safety check --short-report 2>&1; then
        echo -e "${RED}safety found vulnerable dependencies${NC}"
        FAILED=1
    else
        echo -e "${GREEN}safety passed${NC}"
    fi
else
    echo -e "${YELLOW}bandit/safety not installed. Skipping security scan.${NC}"
    echo -e "${YELLOW}Install with: pip install bandit${NC}"
    echo -e "${YELLOW}Or: pip install safety${NC}"
fi

if [ $FAILED -ne 0 ]; then
    echo -e "\n${RED}Pre-commit checks failed. Please fix the issues above.${NC}"
    exit 1
fi

echo -e "\n${GREEN}All pre-commit checks passed!${NC}"
exit 0
