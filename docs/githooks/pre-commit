#!/bin/bash
# ==============================================================================
# TelemetryFlow SDK (Python) - Pre-commit Hook
# ==============================================================================
# Runs quality checks before allowing a commit
# - Black formatting check
# - Ruff linting
# - MyPy type checking
# - Unit tests (optional, fast mode)
# ==============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
success() { echo -e "${GREEN}âœ… $1${NC}"; }
warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
error() { echo -e "${RED}âŒ $1${NC}"; }

echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘      TelemetryFlow SDK (Python) - Pre-commit Checks          â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
STAGED_PY_FILES=$(echo "$STAGED_FILES" | grep '\.py$' | grep -v '_test\.py$' | grep -v 'test_' || true)
STAGED_TEST_FILES=$(echo "$STAGED_FILES" | grep -E '(_test\.py$|test_.*\.py$)' || true)

if [ -z "$STAGED_FILES" ]; then
    warning "No files staged for commit"
    exit 0
fi

info "Staged files:"
echo "$STAGED_FILES" | while read -r file; do
    echo "  - $file"
done
echo ""

# ==============================================================================
# Check 1: Prevent committing sensitive files
# ==============================================================================
info "Checking for sensitive files..."

SENSITIVE_PATTERNS=".env .env.local .env.production credentials secrets private"
for pattern in $SENSITIVE_PATTERNS; do
    if echo "$STAGED_FILES" | grep -qE "(^|/)$pattern"; then
        error "Sensitive file detected: $pattern"
        error "Remove it from staging: git reset HEAD <file>"
        exit 1
    fi
done

# Check for hardcoded secrets patterns in Python files
if [ -n "$STAGED_PY_FILES" ]; then
    for file in $STAGED_PY_FILES; do
        if [ -f "$file" ]; then
            # Check for potential secrets (simple patterns)
            if grep -qE "(password|secret|api_key|apikey|token)\s*=\s*['\"][^'\"]+['\"]" "$file" 2>/dev/null; then
                if ! grep -qE "(os\.environ|os\.getenv|config\.|settings\.)" "$file" 2>/dev/null; then
                    warning "Potential hardcoded secret in: $file"
                    warning "Please review before committing"
                fi
            fi
        fi
    done
fi

success "No sensitive files detected"
echo ""

# ==============================================================================
# Check 2: Black formatting
# ==============================================================================
if [ -n "$STAGED_PY_FILES" ]; then
    if command -v black &> /dev/null; then
        info "Running Black formatting check..."

        if black --check $STAGED_PY_FILES 2>/dev/null; then
            success "Black formatting passed"
        else
            error "Black formatting check failed."
            echo ""
            echo "Run 'black <file>' or 'black .' to fix formatting"
            exit 1
        fi
        echo ""
    else
        warning "Black not installed, skipping formatting check"
        echo "  Install with: pip install black"
        echo ""
    fi
else
    info "No Python source files to format"
    echo ""
fi

# ==============================================================================
# Check 3: isort import sorting
# ==============================================================================
if [ -n "$STAGED_PY_FILES" ]; then
    if command -v isort &> /dev/null; then
        info "Running isort import check..."

        if isort --check-only $STAGED_PY_FILES 2>/dev/null; then
            success "isort passed"
        else
            error "isort check failed."
            echo ""
            echo "Run 'isort <file>' or 'isort .' to fix imports"
            exit 1
        fi
        echo ""
    else
        warning "isort not installed, skipping import check"
        echo "  Install with: pip install isort"
        echo ""
    fi
fi

# ==============================================================================
# Check 4: Ruff linting
# ==============================================================================
if [ -n "$STAGED_PY_FILES" ]; then
    if command -v ruff &> /dev/null; then
        info "Running Ruff linting..."

        if ruff check $STAGED_PY_FILES 2>/dev/null; then
            success "Ruff linting passed"
        else
            error "Ruff linting found issues. Please fix them before committing."
            echo ""
            echo "Run 'ruff check --fix .' to auto-fix some issues"
            exit 1
        fi
        echo ""
    else
        warning "Ruff not installed, skipping linting"
        echo "  Install with: pip install ruff"
        echo ""
    fi
fi

# ==============================================================================
# Check 5: MyPy type checking
# ==============================================================================
if [ -n "$STAGED_PY_FILES" ]; then
    if command -v mypy &> /dev/null; then
        info "Running MyPy type checking..."

        if mypy $STAGED_PY_FILES 2>/dev/null; then
            success "MyPy type checking passed"
        else
            error "MyPy found type errors. Please fix them before committing."
            exit 1
        fi
        echo ""
    else
        warning "MyPy not installed, skipping type checking"
        echo "  Install with: pip install mypy"
        echo ""
    fi
fi

# ==============================================================================
# Check 6: Run related tests (fast mode)
# ==============================================================================
# Check for staged test files (both inline test files and tests/ directory)
STAGED_TESTS_DIR_FILES=$(echo "$STAGED_FILES" | grep '^tests/' || true)

if [ -n "$STAGED_TEST_FILES" ] || [ -n "$STAGED_TESTS_DIR_FILES" ]; then
    info "Running staged test files..."

    if command -v pytest &> /dev/null; then
        # Collect all test files to run
        TEST_FILES=""
        if [ -n "$STAGED_TEST_FILES" ]; then
            TEST_FILES=$(echo "$STAGED_TEST_FILES" | tr '\n' ' ')
        fi
        if [ -n "$STAGED_TESTS_DIR_FILES" ]; then
            TEST_FILES="$TEST_FILES $(echo "$STAGED_TESTS_DIR_FILES" | tr '\n' ' ')"
        fi

        if [ -n "$TEST_FILES" ]; then
            if pytest $TEST_FILES -x --tb=short 2>/dev/null; then
                success "Tests passed"
            else
                error "Tests failed. Please fix failing tests before committing."
                exit 1
            fi
        else
            info "No test files to run"
        fi
    else
        warning "pytest not installed, skipping tests"
        echo "  Install with: pip install pytest"
    fi
    echo ""
elif [ -n "$STAGED_PY_FILES" ]; then
    info "Running quick test check for changed packages..."

    if command -v pytest &> /dev/null; then
        # Also run unit tests if directory exists and has Python test files
        if [ -d "tests/unit" ] && find tests/unit -name "test_*.py" -o -name "*_test.py" 2>/dev/null | grep -q .; then
            if pytest tests/unit -x --tb=short 2>/dev/null; then
                success "Unit tests passed"
            else
                warning "Some unit tests may have failed, but continuing..."
            fi
        fi

        # Get test files related to changed files
        TEST_PATTERNS=""
        for file in $STAGED_PY_FILES; do
            basename=$(basename "$file" .py)
            TEST_PATTERNS="$TEST_PATTERNS test_${basename}.py ${basename}_test.py"
        done

        if pytest --collect-only -q 2>/dev/null | grep -qE "test"; then
            if pytest -x --tb=short 2>/dev/null; then
                success "Related tests passed"
            else
                warning "Some tests may have failed, but continuing..."
            fi
        else
            info "No tests found, skipping"
        fi
    fi
    echo ""
fi

# ==============================================================================
# Check 7: API Compatibility (for SDK)
# ==============================================================================
if [ -n "$STAGED_PY_FILES" ]; then
    info "Checking for breaking API changes..."

    BREAKING_CHANGES=""

    for file in $STAGED_PY_FILES; do
        if [ -f "$file" ]; then
            # Check for removed public functions/classes (simplified)
            DIFF=$(git diff --cached "$file" 2>/dev/null || true)
            if echo "$DIFF" | grep -qE "^-def [a-z]|^-class [A-Z]|^-    def [a-z]"; then
                # Exclude private methods (starting with _)
                if ! echo "$DIFF" | grep -qE "^-def _|^-    def _"; then
                    BREAKING_CHANGES="$BREAKING_CHANGES\n  - $file (possible breaking change)"
                fi
            fi
        fi
    done

    if [ -n "$BREAKING_CHANGES" ]; then
        warning "Possible breaking API changes detected:$BREAKING_CHANGES"
        echo "  Please ensure these changes are intentional and documented"
        echo ""
    else
        success "No obvious breaking API changes detected"
    fi
    echo ""
fi

# ==============================================================================
# Summary
# ==============================================================================
echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘              All pre-commit checks passed! ğŸ‰                â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

exit 0
