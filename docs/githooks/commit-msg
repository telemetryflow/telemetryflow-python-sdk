#!/bin/bash
# ==============================================================================
# TelemetryFlow SDK (Python) - Commit Message Hook
# ==============================================================================
# Validates commit messages follow Conventional Commits format
# https://www.conventionalcommits.org/
#
# Format: <type>(<scope>): <subject>
#
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
# Scope: optional, indicates the module/area affected
# Subject: short description of the change
# ==============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Helper functions
info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
success() { echo -e "${GREEN}âœ… $1${NC}"; }
warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
error() { echo -e "${RED}âŒ $1${NC}"; }

# Get the commit message file
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip validation for merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge "; then
    exit 0
fi

# Skip validation for revert commits
if echo "$COMMIT_MSG" | grep -qE "^Revert "; then
    exit 0
fi

# Skip validation for fixup/squash commits
if echo "$COMMIT_MSG" | grep -qE "^(fixup|squash)! "; then
    exit 0
fi

echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘     TelemetryFlow SDK (Python) - Commit Message Check        â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Get only the first line (subject)
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)

# Define valid types
VALID_TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# Define valid scopes for TelemetryFlow SDK (Python)
VALID_SCOPES="client|tracer|meter|logger|span|metric|log|context|propagator|exporter|sampler|resource|attribute|baggage|config|http|grpc|otlp|console|batch|retry|tls|example|benchmark|async|decorator|middleware|flask|django|fastapi"

# Regex pattern for conventional commits
# Format: type(scope): subject  OR  type: subject
PATTERN="^($VALID_TYPES)(\(($VALID_SCOPES)\))?: .{1,100}$"

# Check if message matches the pattern
if ! echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
    error "Invalid commit message format!"
    echo ""
    echo -e "${YELLOW}Your message:${NC}"
    echo "  $FIRST_LINE"
    echo ""
    echo -e "${CYAN}Expected format:${NC}"
    echo "  <type>(<scope>): <subject>"
    echo "  or"
    echo "  <type>: <subject>"
    echo ""
    echo -e "${CYAN}Valid types:${NC}"
    echo "  feat     - A new feature"
    echo "  fix      - A bug fix"
    echo "  docs     - Documentation only changes"
    echo "  style    - Code style changes (formatting, etc)"
    echo "  refactor - Code change that neither fixes a bug nor adds a feature"
    echo "  perf     - Performance improvements"
    echo "  test     - Adding or correcting tests"
    echo "  build    - Build system or external dependencies"
    echo "  ci       - CI configuration files and scripts"
    echo "  chore    - Other changes that don't modify src or test files"
    echo "  revert   - Reverts a previous commit"
    echo ""
    echo -e "${CYAN}Valid scopes (optional):${NC}"
    echo "  client, tracer, meter, logger, span, metric, log, context,"
    echo "  propagator, exporter, sampler, resource, attribute, baggage,"
    echo "  config, http, grpc, otlp, console, batch, retry, tls, example,"
    echo "  benchmark, async, decorator, middleware, flask, django, fastapi"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  feat(tracer): add automatic context propagation"
    echo "  fix(exporter): resolve async export buffer issue"
    echo "  docs: update SDK installation guide"
    echo "  refactor(decorator): simplify trace decorator logic"
    echo "  test(fastapi): add integration tests for FastAPI middleware"
    echo ""
    exit 1
fi

# Check subject length
SUBJECT_LENGTH=${#FIRST_LINE}
if [ "$SUBJECT_LENGTH" -gt 100 ]; then
    error "Commit message subject is too long!"
    echo ""
    echo "  Current length: $SUBJECT_LENGTH characters"
    echo "  Maximum allowed: 100 characters"
    echo ""
    echo "Please shorten your commit message."
    exit 1
fi

# Check for period at the end
if echo "$FIRST_LINE" | grep -qE "\.$"; then
    warning "Commit message should not end with a period"
    echo "  Consider removing the trailing period"
fi

# Check for uppercase first letter after colon
SUBJECT=$(echo "$FIRST_LINE" | sed 's/^[^:]*: //')
FIRST_CHAR=$(echo "$SUBJECT" | cut -c1)
if echo "$FIRST_CHAR" | grep -qE "[A-Z]"; then
    warning "Subject should start with lowercase letter"
    echo "  Current: $SUBJECT"
    echo "  Consider: $(echo "$SUBJECT" | sed 's/^./\L&/')"
fi

# Extract type for emoji suggestion
TYPE=$(echo "$FIRST_LINE" | sed 's/^\([^(:]*\).*/\1/')

# Success message with emoji based on type
case "$TYPE" in
    feat)     EMOJI="âœ¨" ;;
    fix)      EMOJI="ğŸ›" ;;
    docs)     EMOJI="ğŸ“š" ;;
    style)    EMOJI="ğŸ’„" ;;
    refactor) EMOJI="â™»ï¸" ;;
    perf)     EMOJI="âš¡" ;;
    test)     EMOJI="ğŸ§ª" ;;
    build)    EMOJI="ğŸ”¨" ;;
    ci)       EMOJI="ğŸ‘·" ;;
    chore)    EMOJI="ğŸ”§" ;;
    revert)   EMOJI="âª" ;;
    *)        EMOJI="ğŸ“" ;;
esac

echo ""
success "Commit message is valid! $EMOJI"
echo ""
echo -e "  ${CYAN}Type:${NC} $TYPE"

# Extract and display scope if present
if echo "$FIRST_LINE" | grep -qE "^[^(]+\([^)]+\)"; then
    SCOPE=$(echo "$FIRST_LINE" | sed 's/^[^(]*(\([^)]*\)).*/\1/')
    echo -e "  ${CYAN}Scope:${NC} $SCOPE"
fi

echo -e "  ${CYAN}Subject:${NC} $SUBJECT"
echo ""

exit 0
