#!/bin/bash

# Commit-msg hook for TelemetryFlow projects
# Enforces Conventional Commits format
# https://www.conventionalcommits.org/

set -e

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge"; then
    exit 0
fi

# Conventional commit pattern
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
# Optional scope in parentheses
# Optional breaking change indicator (!)
# Colon and space, then description
PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?(!)?: .{1,}"

# Check if commit message follows conventional commits format
if ! echo "$COMMIT_MSG" | head -1 | grep -qE "$PATTERN"; then
    echo -e "${RED}ERROR: Commit message does not follow Conventional Commits format.${NC}"
    echo ""
    echo -e "${YELLOW}Your commit message:${NC}"
    echo "$COMMIT_MSG" | head -1
    echo ""
    echo -e "${YELLOW}Expected format:${NC}"
    echo "  <type>[optional scope][!]: <description>"
    echo ""
    echo -e "${YELLOW}Allowed types:${NC}"
    echo "  feat:     A new feature"
    echo "  fix:      A bug fix"
    echo "  docs:     Documentation only changes"
    echo "  style:    Code style changes (formatting, semicolons, etc)"
    echo "  refactor: Code change that neither fixes a bug nor adds a feature"
    echo "  perf:     Performance improvement"
    echo "  test:     Adding or updating tests"
    echo "  build:    Build system or external dependency changes"
    echo "  ci:       CI configuration changes"
    echo "  chore:    Other changes that don't modify src or test files"
    echo "  revert:   Reverts a previous commit"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  feat: add user authentication"
    echo "  fix(api): resolve null pointer in handler"
    echo "  docs: update README with installation steps"
    echo "  feat(auth)!: change token format (breaking change)"
    echo ""
    exit 1
fi

# Check minimum description length (at least 10 characters after the type)
DESCRIPTION=$(echo "$COMMIT_MSG" | head -1 | sed -E 's/^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?(!)?: //')
if [ ${#DESCRIPTION} -lt 10 ]; then
    echo -e "${RED}ERROR: Commit description is too short (minimum 10 characters).${NC}"
    echo -e "${YELLOW}Current description:${NC} $DESCRIPTION"
    exit 1
fi

# Check that description doesn't start with capital letter (optional but recommended)
if echo "$DESCRIPTION" | grep -qE "^[A-Z]"; then
    echo -e "${YELLOW}WARNING: Description should start with lowercase letter.${NC}"
    echo -e "${YELLOW}Current:${NC} $DESCRIPTION"
    # This is just a warning, not a failure
fi

# Check commit message line length (first line should be <= 72 characters)
FIRST_LINE_LENGTH=$(echo "$COMMIT_MSG" | head -1 | wc -c | tr -d ' ')
if [ "$FIRST_LINE_LENGTH" -gt 72 ]; then
    echo -e "${YELLOW}WARNING: First line exceeds 72 characters (${FIRST_LINE_LENGTH} chars).${NC}"
    echo -e "${YELLOW}Consider shortening the commit message.${NC}"
    # This is just a warning, not a failure
fi

echo -e "${GREEN}Commit message follows Conventional Commits format.${NC}"
exit 0
