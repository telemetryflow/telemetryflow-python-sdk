#!/bin/bash

# Pre-push hook for TelemetryFlow Python SDK
# Runs tests before pushing to remote

set -e

echo "Running pre-push checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

REMOTE="$1"
URL="$2"

# Read stdin for push info
while read local_ref local_sha remote_ref remote_sha; do
    # Skip delete operations
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi

    echo -e "${YELLOW}Pushing to: ${REMOTE} (${URL})${NC}"
    echo -e "${YELLOW}Branch: ${local_ref}${NC}"
done

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

FAILED=0

# 1. Run tests
echo -e "\n${YELLOW}[1/2] Running tests...${NC}"
if command_exists pytest; then
    if pytest -v --tb=short 2>&1; then
        echo -e "${GREEN}All tests passed${NC}"
    else
        echo -e "${RED}Tests failed${NC}"
        FAILED=1
    fi
elif command_exists python && python -c "import unittest" 2>/dev/null; then
    echo -e "${YELLOW}pytest not found, using unittest...${NC}"
    if python -m unittest discover -s tests -v 2>&1; then
        echo -e "${GREEN}All tests passed${NC}"
    else
        echo -e "${RED}Tests failed${NC}"
        FAILED=1
    fi
else
    echo -e "${YELLOW}No test runner found. Skipping tests.${NC}"
    echo -e "${YELLOW}Install with: pip install pytest${NC}"
fi

# 2. Check if package can be built/imported
echo -e "\n${YELLOW}[2/2] Checking package import...${NC}"
if command_exists python; then
    # Try to import the main package
    if python -c "import sys; sys.path.insert(0, 'src'); import telemetryflow" 2>&1; then
        echo -e "${GREEN}Package import successful${NC}"
    else
        echo -e "${RED}Package import failed${NC}"
        FAILED=1
    fi
else
    echo -e "${YELLOW}Python not found. Skipping import check.${NC}"
fi

if [ $FAILED -ne 0 ]; then
    echo -e "\n${RED}Pre-push checks failed. Push aborted.${NC}"
    echo -e "${YELLOW}Fix the issues above and try again.${NC}"
    exit 1
fi

echo -e "\n${GREEN}All pre-push checks passed! Pushing...${NC}"
exit 0
